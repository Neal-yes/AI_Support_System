import{d as J,r as i,c as G,u as K,o as Q,w as O,a as X,b as c,e,t as l,f as n,g as V,h as y,v as Y,i as Z,j as L,k as $,F as ee,l as te,m as d,_ as ae}from"./index-esQvTIoC.js";const oe={class:"card"},le={class:"row"},ne={class:"row"},se=["placeholder"],ie={class:"row"},re={class:"hint"},ue={class:"row"},ce={class:"hint"},de={key:0,class:"row warn"},ve={key:1,class:"row"},fe={class:"hint"},me={key:2,class:"preflight"},pe={class:"preflight-title"},he=["disabled"],_e={class:"preflight-body"},ge={key:0},be={key:0,class:"preflight-error"},ye={key:1},we={key:2},ke={key:3},xe={class:"row"},Te={class:"row"},Se={class:"row"},Pe={class:"row"},Ce=["disabled"],Ee=["disabled"],Ie=["data-on"],Me={class:"output"},Ve=J({__name:"Home",setup(Le){const w=i("请简要回答（两句话内）"),r=i(!1),p=i(2e3),k=i(6e4),U=i(8),h=i(!1),P=i(""),u=i("idle");let _=null,g;const j=G(()=>u.value==="idle"?"idle":u.value==="started"?"started":u.value==="streaming"?"streaming":u.value==="done"?"done":"error"),{t:s,locale:x}=K();function C(){g&&window.clearTimeout(g);const o=p.value&&p.value>0?p.value*3:2e4;g=window.setTimeout(()=>{T("[client] idle-timeout, aborting stream"),q()},o)}function T(o){P.value+=(P.value?`
`:"")+o}Q(()=>{try{const o=localStorage.getItem("lang");(o==="zh"||o==="en")&&(x.value=o);const t=localStorage.getItem("useRag");t!==null&&(r.value=t==="1")}catch{}}),O(r,o=>{try{localStorage.setItem("useRag",o?"1":"0")}catch{}}),O(x,o=>{try{localStorage.setItem("lang",o)}catch{}});const b=i({ok:!0,contexts_count:0,ctx_total_len:0,max_score:null,avg_score:null}),E=i(!1),v=i("none"),I=i("");let S;function M(o){return typeof o=="number"?o.toFixed(2):"—"}async function N(){if(!r.value){v.value="none";return}const o=(w.value||"").trim();if(o.length<2){v.value="none";return}E.value=!0;try{const t=await fetch("/api/v1/rag/preflight",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o})});if(!t.ok)throw new Error("HTTP "+t.status);const a=await t.json();if(b.value=a,a&&a.ok===!1){I.value=a.error||"",v.value="none";return}else I.value="";const f=(a?.ctx_total_len||0)>=80&&(a?.contexts_count||0)>0,m=typeof a?.max_score=="number"?a.max_score:0;f&&m>=.7?v.value="good":f?v.value="weak":v.value="none"}catch(t){v.value="none",I.value=t?.message||String(t||"")}finally{E.value=!1}}function B(){S&&window.clearTimeout(S),S=window.setTimeout(N,500)}O([r,w],()=>B());async function A(){if(h.value)return;P.value="",u.value="idle";const o={query:w.value,use_rag:r.value,options:{num_predict:U.value}};p.value&&p.value>0&&(o.options.heartbeat_ms=p.value),k.value&&k.value>0&&(o.options.time_limit_ms=k.value),_=new AbortController,h.value=!0,u.value="started",C();try{const t=await fetch("/api/v1/ask/stream",{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(o),signal:_.signal});if(!t.ok||!t.body)throw new Error("HTTP "+t.status);const a=t.body.getReader(),f=new TextDecoder("utf-8");let m="";for(;;){const{value:D,done:F}=await a.read();if(F)break;const W=f.decode(D,{stream:!0});m+=W;let H;for(;(H=m.indexOf(`

`))!==-1;){const z=m.slice(0,H);m=m.slice(H+2),R(z)}}m.trim().length&&R(m),u.value="done"}catch(t){t?.name==="AbortError"?T("[client] aborted"):(T("[client] error: "+(t?.message||String(t))),u.value="error")}finally{h.value=!1,g&&window.clearTimeout(g)}}function R(o){const t=o.split(`
`);for(const a of t){if(!a.startsWith("data:"))continue;const f=a.slice(5).trimStart();if(f==="[started]"){u.value="streaming",C();continue}if(f==="[heartbeat]"){C();continue}if(f==="[done]"){u.value="done",T("[done]"),_&&_.abort();return}T(f),C()}}function q(){_&&(_.abort(),_=null),h.value=!1}return X(()=>{q(),g&&window.clearTimeout(g),S&&window.clearTimeout(S)}),(o,t)=>(d(),c("section",oe,[e("h2",null,l(n(s)("title")),1),e("form",{onSubmit:te(A,["prevent"])},[e("div",le,[e("label",null,l(n(s)("lang")),1),y(e("select",{"onUpdate:modelValue":t[0]||(t[0]=a=>Z(x)?x.value=a:null)},[...t[6]||(t[6]=[e("option",{value:"zh"},"中文",-1),e("option",{value:"en"},"English",-1)])],512),[[Y,n(x)]])]),e("div",ne,[e("label",null,l(n(s)("query")),1),y(e("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>w.value=a),placeholder:n(s)("queryPlaceholder")},null,8,se),[[L,w.value]])]),e("div",ie,[e("label",null,l(n(s)("ragLabel")),1),y(e("input",{type:"checkbox","onUpdate:modelValue":t[2]||(t[2]=a=>r.value=a)},null,512),[[$,r.value]]),e("small",re,l(n(s)("ragHint")),1)]),e("div",ue,[e("small",ce,l(n(s)("ragImpact")),1)]),r.value?(d(),c("div",de,[e("span",null,l(n(s)("ragWarn")),1)])):V("",!0),r.value?(d(),c("div",ve,[e("small",fe,l(n(s)("thresholdTip")),1)])):V("",!0),r.value?(d(),c("div",me,[e("div",pe,[e("span",null,l(n(s)("preflightTitle")),1),e("button",{type:"button",class:"retry",disabled:E.value,onClick:N},l(n(s)("retry")),9,he)]),e("div",_e,[E.value?(d(),c("span",ge,l(n(s)("preflightLoading")),1)):(d(),c(ee,{key:1},[b.value&&b.value.ok===!1?(d(),c("div",be,l(n(s)("preflightErr",{err:I.value||"unknown"})),1)):V("",!0),v.value==="good"?(d(),c("span",ye,l(n(s)("preflightGood",{max:M(b.value.max_score),avg:M(b.value.avg_score)})),1)):v.value==="weak"?(d(),c("span",we,l(n(s)("preflightWeak",{max:M(b.value.max_score),avg:M(b.value.avg_score)})),1)):(d(),c("span",ke,l(n(s)("preflightNoHit")),1))],64))])])):V("",!0),e("div",xe,[e("label",null,l(n(s)("heartbeat")),1),y(e("input",{type:"number","onUpdate:modelValue":t[3]||(t[3]=a=>p.value=a),min:"0",step:"100"},null,512),[[L,p.value,void 0,{number:!0}]])]),e("div",Te,[e("label",null,l(n(s)("timeLimit")),1),y(e("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=a=>k.value=a),min:"0",step:"500"},null,512),[[L,k.value,void 0,{number:!0}]])]),e("div",Se,[e("label",null,l(n(s)("numPredict")),1),y(e("input",{type:"number","onUpdate:modelValue":t[5]||(t[5]=a=>U.value=a),min:"1",step:"1"},null,512),[[L,U.value,void 0,{number:!0}]])]),e("div",Pe,[e("button",{type:"submit",disabled:h.value},l(n(s)("start")),9,Ce),e("button",{type:"button",onClick:q,disabled:!h.value},l(n(s)("stop")),9,Ee),e("span",{class:"status","data-on":h.value},l(j.value),9,Ie)])],32),e("pre",Me,l(P.value),1)]))}}),qe=ae(Ve,[["__scopeId","data-v-aed1b69f"]]);export{qe as default};
