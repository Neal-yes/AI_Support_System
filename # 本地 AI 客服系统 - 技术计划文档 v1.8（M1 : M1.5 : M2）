# 本地 AI 客服系统 - 技术计划文档 v1.8（M1 / M1.5 / M2）

更新时间：2025-08-13  
适用文档：配合《本地 AI 客服系统 - 产品需求文档 v1.8》使用  
目标：将“环境/模型/数据库/网关/安全/监控/CI/CD/评测/回滚”等实施事项落实为可执行任务清单，服务每个里程碑的上线验收。

---

## 1. 约定与角色
- 状态：TODO / DOING / DONE / BLOCKED
- 负责人：@owner（单一责任人）
- 截止：YYYY-MM-DD
- 依赖：前序任务、外部接口或资源（如网络白名单、账号）
- 产出：脚本/配置/文档/验证记录/演练记录
- 环境：dev / staging / prod（如无 staging，则按 dev→prod）

---

## 2. 能力构建流（按执行顺序，唯一规范源）

### 2.1 环境与容器
- 基础设施：Docker/Compose、镜像仓库（含国内加速）、网络/防火墙、持久化卷
- 运行时：Python 3.11、Node 18+、包管理器（pip/npm）镜像源
- 密钥管理：KMS/Vault/Keychain，分环境/分租户最小权限，注入与审计
- 备份与恢复：频率、介质、恢复演练记录（RTO/RPO）

### 2.2 模型与推理
- 模型：Qwen2.5 7B/14B（llama.cpp/Ollama），权重来源校验
- 性能：并发基线、P95 延迟、量化策略、KV/embedding 缓存
- 端点：OpenAI 兼容或本地直连；超时/重试策略
- 安全：输入输出审计、脱敏标记、最大 tokens 与预算

### 2.3 向量库与嵌入
- 数据库：Qdrant（arm64/x86_64），集合 schema、HNSW/IVF 参数
- 持久化：卷挂载 ./data/qdrant:/qdrant/storage；端口 6333/6334
- 嵌入：bge-m3（或 bge-small-zh），批量脚本与去重/补召回
- 索引与回填：初始构建、增量同步、重建策略
- 健康检查：
  ```bash
  curl -sS http://localhost:6333/collections
  ```

### 2.4 数据库与 DB_QUERY 模板
- 账户与网络：只读账号、白名单、连接池/超时
- 只读视图：参数化 SELECT、禁 DML/DDL/注释/危险关键字；EXPLAIN 审核
- 模板治理：request/response schema、最大行数、超时、字段投影/脱敏、输出稳定性

### 2.5 工具网关（/tools/invoke）
- 策略：限流/缓存/重试/熔断、并发上限、超时
- singleflight：hash(tenant_id, tool_type, tool_name, normalized_params)
- 安全：域名/路径白名单、入参校验、输出字段白名单与脱敏
- 自测台：沙箱执行、展示校验/投影/脱敏后响应

### 2.6 后端 API（/api/v1）
- 规范：kebab-case 路由、OpenAPI 3.1、JSON snake_case、SSE/Chunked 支持
- 核心接口：问答 /api/v1/ask；管理 /api/v1/admin/*；工具 /api/v1/tools/invoke
- 评测接口：
  - GET/POST /api/v1/admin/evals
  - GET/PUT/DELETE /api/v1/admin/evals/{id}
  - POST /api/v1/admin/evals/{id}/import
  - POST /api/v1/admin/evals/{id}/runs
  - GET /api/v1/admin/eval-runs
  - GET /api/v1/admin/eval-runs/{run_id}

### 2.7 前端（Admin 后台 + Chat）
- Admin：工具治理、组织与主数据、版本化与发布、评测与报告、审计与告警
- Chat：会话、引用展示、工具摘要显隐、错误/越权提示
- 版本一致性：右上角显示“Vx.y.z”，与发布版本同步（引用《PRD》第8章）

### 2.8 安全与防护
- 网关：签名/时间戳/防重放、IP/用户/租户限流、WAF 接入
- 应用：敏感词/PII 检测、Prompt Injection/Jailbreak 检测、响应 schema 校验
- 账户：强密码、登录保护、可选 2FA、临时提权审批与审计

### 2.9 可观测与告警
- 指标/日志/Trace：统一 trace_id、tenant_id、config_version 透传
- 告警：错误率、熔断、超时、QPS 异常、缓存命中率下滑
- 审计：user_id、roles、data_scope、action、result、reason_code

### 2.10 评测与 CI/CD 门禁
- 阈值（可按业务微调）
  - M1：命中率≥0.60、忠实度≥0.85、拒答正确率≥0.80、引用正确性≥0.85
  - M1.5：命中率≥0.70、忠实度≥0.88、拒答正确率≥0.85、引用正确性≥0.90
  - M2：命中率≥0.75、忠实度≥0.90、拒答正确率≥0.90、引用正确性≥0.92
- 集合分层：冒烟集（PR 必跑）/回归主集（发布前）/长测集（夜间）
- CI/CD 集成：
  - CI：push/PR 触发冒烟集；不达标阻断合并
  - CD：pre-deploy 触发回归主集；不达标阻断发布
- 产物：JSON/HTML 报告，失败样本附 trace_id、config_version 回链审计
- 参照：《PRD v1.8》第11.1/第13章

### 2.11 变更与回滚
- 版本流程：Draft → Validated → Gray → Live → RolledBack/Archived
- 请求内快照：同一请求内固定 config_version
- 回滚：配置快照、缓存刷新、验证步骤；季度演练记录

### 2.12 本地开发（macOS）要点（内嵌，不单独附录）
- 目的：Apple Silicon 上的最小可运行环境，便于开发/联调/演示；与服务器保持容器一致性。
- 前置
  - macOS 13+（Apple Silicon 推荐），Docker Desktop（启用 VirtioFS，CPU≥6 / RAM≥12GB）
  - Homebrew、Git、Python 3.11+、Node 18+（按需）
- 模型运行（二选一）
  - Ollama：
    ```bash
    brew install ollama
    ollama serve &
    ollama pull qwen2.5:latest
    ```
  - llama.cpp + Metal：
    ```bash
    # 编译带 Metal 的 llama.cpp（略）
    ./main -m qwen2.5.gguf -p "hello" --gpu-layers 20
    ```
- 向量库与编排（Docker Compose）
  ```bash
  docker compose -f docker-compose.dev.yaml up -d
  # 典型服务：api网关、admin-frontend、qdrant、redis（可选）
  ```
- Qdrant 持久化与网络
  - 卷：./data/qdrant:/qdrant/storage
  - 端口：:6333（HTTP），:6334（gRPC）
- 健康检查：
  ```bash
  curl -sS http://localhost:6333/collections
  ```
- 嵌入与索引
  ```bash
  python scripts/embed.py --model bge-m3 --input docs/ --out ./.cache/embeddings
  python scripts/index_qdrant.py --collection kb_main --emb ./.cache/embeddings
  ```
- 环境变量
  ```bash
  cp .env.example .env
  export TENANT_ID=acme
  export QDRANT_URL=http://localhost:6333
  export LLM_ENDPOINT=http://localhost:11434/v1  # ollama openai 兼容端点（如适用）
  export EMB_MODEL=bge-m3
  ```
- 最小自检
  ```bash
  curl -sS http://localhost:8080/healthz
  curl -sS http://localhost:6333/collections
  curl -sS -X POST http://localhost:8080/api/v1/ask -H 'Content-Type: application/json' \
    -d '{"query":"你好","tenant_id":"acme"}'
  curl -sS -X POST 'http://localhost:8080/api/v1/admin/evals/{id}/runs' \
    -d '{"config_version":"Vx.y.z"}'
  ```
- 常见问题
  - 端口冲突：调整 compose 端口映射或释放占用
  - 内存不足：提升 Docker RAM 配额；模型用量化版；启用缓存
  - 下载慢：配置国内镜像（pip/npm/docker）
  - 注：本地与服务器配置均走“第8章 版本化流程”，严禁本地旁路直改线上参数。

## 3. 里程碑就绪清单（M1 / M1.5 / M2）

### 3.1 M1 就绪清单（最小可用闭环）
目标：跑通“登录与权限 → RAG ACL → HTTP 工具网关 → 组织与权限后台 → 企业微信 → 备份/评测”的闭环能力。

| 模块   | 任务                  | 验证标准                                  | 负责人 | 截止       | 状态 |
|--------|-----------------------|-------------------------------------------|--------|------------|------|
| 环境   | Docker Compose 启停脚本 | 服务可启停，健康检查 200                  |        |            |      |
| 模型   | Qwen2.5 部署          | /api/v1/ask P95≤2s（缓存命中）            |        |            |      |
| RAG    | Qdrant 初始化         | TopK 命中率基线达标（记录阈值）           |        |            |      |
| 网关   | HTTP 工具执行         | Schema 校验/投影/熔断/限流生效            |        |            |      |
| 权限   | 角色/数据范围         | 授权模拟通过；审计含 reason_code          |        |            |      |
| 前端   | 版本号一致性          | 右上角 Vx.y.z 与发布版本同步              |        |            |      |
| 监控   | 告警规则              | 错误率/熔断/超时可触发告警                |        |            |      |
| 备份   | 备份与恢复            | 完成一次恢复演练（记 RTO/RPO）            |        |            |      |
| 评测   | 门禁配置              | CI 冒烟集（本里程碑阈值）；失败阻断合并 |        |            |      |
| 发布   | 发布前评测            | CD pre-deploy 回归主集；未达阈值阻断发布 |        |            |      |
| 本地   | macOS 最小验证        | compose 启动；/healthz 200；/ask 正常；Qdrant 集合就绪 |        |            |      |

### 3.2 M1.5 就绪清单（关键增强）
目标：补齐 DB 查询与复合编排能力，服务真实业务场景。

| 模块   | 任务                  | 验证标准                                  | 负责人 | 截止       | 状态 |
|--------|-----------------------|-------------------------------------------|--------|------------|------|
| DB     | 只读视图与模板        | 仅 SELECT、EXPLAIN 通过、限行限时生效     |        |            |      |
| 工具   | DB_QUERY 执行器       | 输出 schema 稳定、审计包含模板版本        |        |            |      |
| 工具   | 复合编排              | 串/并行策略、预算/singleflight 生效       |        |            |      |
| 评测   | 模板回归              | 会员/店铺/合同/结算/订单模板通过回归      |        |            |      |
| 评测   | 门禁配置              | CI 冒烟集（本里程碑阈值）；失败阻断合并 |        |            |      |
| 发布   | 发布前评测            | CD pre-deploy 回归主集；未达阈值阻断发布 |        |            |      |
| 本地   | macOS 最小验证        | compose 启动；/healthz 200；/ask 正常；Qdrant 集合就绪 |        |            |      |

### 3.3 M2 就绪清单（规模化与治理）
目标：权限深化、自动化评测、强隔离多租户与完整前端能力。

| 模块   | 任务                  | 验证标准                                  | 负责人 | 截止       | 状态 |
|--------|-----------------------|-------------------------------------------|--------|------------|------|
| 权限   | ABAC/列级脱敏         | 策略引擎上线、字段脱敏正确率达标          |        |            |      |
| 多租户 | 强隔离                | 数据/配置/日志完全隔离，配额生效          |        |            |      |
| 评测   | 自动回归              | 合入即评测，未达阈值阻断发布              |        |            |      |
| 前端   | Vue Chat 完整版       | 体验指标与可访问性达标                    |        |            |      |
| 评测   | 门禁配置              | CI 冒烟集（本里程碑阈值）；失败阻断合并 |        |            |      |
| 发布   | 发布前评测            | CD pre-deploy 回归主集；未达阈值阻断发布 |        |            |      |
| 本地   | macOS 最小验证        | compose 启动；/healthz 200；/ask 正常；Qdrant 集合就绪 |        |            |      |

## 4. 验收与门禁（DOR/DOD）
- 上线门禁（DOR）：对应里程碑“就绪清单”全部 DONE，且演练记录齐全。
- 发布门禁（DOD）：通过《PRD v1.8》第15章验收标准；关键指标入审计与监控。

## 5. 变更控制与回滚
- 变更单模板：变更内容/影响面/回退点/负责人/时间窗/验证清单
- 回滚：配置快照回滚步骤、缓存刷新、请求内快照一致性验证
- 演练：季度至少一次跨模块回滚演练，记录耗时与问题单

## 6. 附录
- 产出物清单：部署脚本、环境变量清单、密钥管理说明、OpenAPI 文档、评测集与报告、Runbook
- 参考：PRD v1.8 第5/8/10/11/12/13/17 章节规范

### 6.1 评测产物与导入模板
- 评测集导入：CSV/JSON（字段：query, expected_answer/rubric, check_type, labels, context.tenant_id, context.user_context.*）
- 评测报告：总览指标 + 失败样本清单（含 trace_id、config_version、链接到审计日志）
- API：/api/v1/admin/evals, /api/v1/admin/evals/{id}/runs, /api/v1/admin/eval-runs/{run_id}